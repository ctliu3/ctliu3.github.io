<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>参数服务器</title>
<meta name=description content="Moments of Life"><meta name=keywords content="AI Infra,Deep Learning"><meta property="og:url" content="https://ctliu3.xyz/posts/parameter-server/"><meta property="og:type" content="website"><meta property="og:title" content="参数服务器"><meta property="og:description" content="Moments of Life"><meta property="og:image" content="https://ctliu3.xyz/avatar.png"><meta property="og:image:secure_url" content="https://ctliu3.xyz/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="参数服务器"><meta name=twitter:description content="Moments of Life"><meta property="twitter:domain" content="https://ctliu3.xyz/posts/parameter-server/"><meta property="twitter:url" content="https://ctliu3.xyz/posts/parameter-server/"><meta name=twitter:image content="https://ctliu3.xyz/avatar.png"><link rel=canonical href=https://ctliu3.xyz/posts/parameter-server/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.edd985581bf860dfb4507e5885197f1680160c7fe19f23b31e183126d99dd596.js integrity="sha256-7dmFWBv4YN+0UH5YhRl/FoAWDH/hnyOzHhgxJtmd1ZY="></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css integrity=sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js integrity=sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://ctliu3.xyz/><img src=/avatar.png alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://ctliu3.xyz/>自由の灵魂</a></div><div class=nav-links><div class=nav-link><a href=https://ctliu3.xyz/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://ctliu3.xyz/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://ctliu3.xyz/about><span data-feather=user></span> About</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://ctliu3.xyz/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://ctliu3.xyz/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://ctliu3.xyz/about><span data-feather=user></span> About</a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>参数服务器</h1><small role=doc-subtitle></small><p class=post-date>十一月 12, 2016</p><ul class=post-tags><li class=post-tag><a href=https://ctliu3.xyz/tags/ai-infra>AI Infra</a></li><li class=post-tag><a href=https://ctliu3.xyz/tags/deep-learning>Deep Learning</a></li></ul></div><div class=post-content><p><p>参数服务器（Parameter Sever）是大规模机器学习的一个部分，比如 dmlc 中的 <a href=https://github.com/dmlc/ps-lite>ps-lite</a>, 比如微软的 <a href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=0ahUKEwiiqp-RiaPQAhUDsI8KHZnNDBMQFgggMAA&amp;url=https%3A%2F%2Fpdfs.semanticscholar.org%2F043a%2Ffbd936c95d0e33c4a391365893bd4102f1a7.pdf&amp;usg=AFQjCNFFnirPzFhPQQ4KTeDH5MX8ff1OEw&amp;sig2=iQsdfQFyUcPhG8kkP9B0-g">project adam</a>。本质上来，参数服务器就是个分布式系统，用于更新机器学习的模型参数。因此，一个完善的参数服务器要考虑到错误容忍、可扩展性、数据一致性等。</p><h1 id=基本架构>基本架构</h1><p>以 ps-lite 为例，ps-lite 从架构上来说是由 server, worker, scheduler 组成，三者的职责如下</p><ul><li>Sheduler 是个调度器，比如控制训练时的数据同步，对失败结点和新添结点的处理。Sheduler 并不对系统资源使用进行监控和优化分配。</li><li>Server 主要用于数据（在深度学习中，该数据就是梯度）的收集和模型的更新，server 之间会相互通信，进行数据的备份，防止 server 结点失败。</li><li>Worker 用于训练模型。Worker 结点之间不进行通信，因此，如果有一个结点失败了，不会影响其他结点的训练。Worker 有两个主要的操作：push 数据到 server, 从 server pull 数据到本地。</li></ul><p>代码层面，ps-lite 使用 Postoffice 类作为信息获取和消息通信的统一入口，使用 zeromq 进行消息通信，消息使用 protobuf 进行封装。</p><h1 id=同步异步>同步、异步</h1><p>支持同步和异步的训练是参数服务器一个特性。</p><ul><li><p>同步。直观上来讲，同步就是个 map-reduce 的过程。Server 结点必须等到所有数据都收集完整了，才能进行模型的更新。对于凸优化，同步的训练方式可以保证数据的收敛。但，同步的训练方式对机器的要求比较高，因为如果有一个 worker 结点计算速度过慢，会严重影响训练速度。此外，从实现上而言，同步更容易进行调试。</p></li><li><p>异步。每个 worker 结点可以在任何时刻从 server 结点拉取模型数据进行训练。即每个 worker 结点上的模型可能是不一样的。异步的方式从实现上更为简单，因为它只需要保证 server 结点对更新模型操作时的互斥，而不需要处理不同 worker 结点的同步问题。目前，对于大规模的学习任务，基本都会采用异步的训练方式，但并非所有的算法都支持异步的训练。异步通常来讲会降低模型的收敛速度，甚至导致模型不收敛。因此，实现异步训练，要有相应算法的支持。</p></li></ul><p>在 ps-lite 中，可以通过 Barrier() 函数来实现结点间的同步。比如，如果我想在 server 结点初始化好模型前，阻塞所有 worker 结点的 pull 操作。可以在每个 worker 结点加入该操作（具体细节可参考 <a href=https://github.com/ctliu3/dist-lr/blob/master/src/main.cc>dist-lr</a> 的实现）：</p><pre><code>ps::Postoffice::Get()-&gt;Barrier(ps::kWorkerGroup);
</code></pre><p>此外，ps-lite 也利用时间戳的方式来实现同步训练。每个 worker 结点在给 push 数据给 server 时，都会带上一个时间戳，该时间戳对应一个回调函数。Server 结点的 response 中会带上该时间戳，这样就使得 worker 结点会在 server 返回结果前阻塞，而在收到 response 时执行相应的函数。</p><h1 id=dist-lrhttpsgithubcomctliu3dist-lr><a href=https://github.com/ctliu3/dist-lr>dist-lr</a></h1><p>dist-lr 是我基于 ps-lite 写的一个分布式 logistic regression 的项目。目前实现的是带 L2 正则的单机版本，但只要做一些数据拷贝的处理，很容易扩展成多机的版本。支持同步和异步的训练。</p><p><a href=https://github.com/ctliu3/dist-lr/tree/master/examples>examples</a> 目录下放了个 demo，数据集是 <a href=https://www.csie.ntu.edu.tw/~cjlin/libsvmtools/datasets/binary.html>a9a</a>, 这是一个二分类数据，特征维度为 123, 正样本有 32561 个，负样本有 16281 个。为了测试数据并行的效果，我把训练集分成了 4 份。训练时迭代了 20 次。</p><table><thead><tr><th></th><th style=text-align:center>elapsed</th><th style=text-align:center>accuracy</th></tr></thead><tbody><tr><td>sync</td><td style=text-align:center>92s</td><td style=text-align:center>82.9%</td></tr><tr><td>async</td><td style=text-align:center>69s</td><td style=text-align:center>80.4%</td></tr></tbody></table><p>同步训练时，准确率是一直上升的，而异步时，准确率会有比较大的振荡，无法很好的收敛。下面是某一次异步训练时的收敛情况：</p><pre><code> 09:51:38 Iteration  20, accuracy: 0.690682
 09:51:46 Iteration  40, accuracy: 0.725201
 09:51:53 Iteration  60, accuracy: 0.845955
 09:52:01 Iteration  80, accuracy: 0.790861
 09:52:08 Iteration 100, accuracy: 0.819114
 09:52:16 Iteration 120, accuracy: 0.776856
 09:52:24 Iteration 140, accuracy: 0.773847
 09:52:31 Iteration 160, accuracy: 0.811498
 09:52:39 Iteration 180, accuracy: 0.836619
 09:52:47 Iteration 200, accuracy: 0.804312
</code></pre></p></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="topFunction()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg><script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function topFunction(){smoothScrollToTop()}function smoothScrollToTop(){const e=()=>{const t=document.documentElement.scrollTop||document.body.scrollTop;t>0&&(window.requestAnimationFrame(e),window.scrollTo(0,t-t/8))};e()}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><a href=#基本架构>基本架构</a></li><li><a href=#同步异步>同步、异步</a></li><li><a href=#dist-lrhttpsgithubcomctliu3dist-lr><a href=https://github.com/ctliu3/dist-lr>dist-lr</a></a></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2023 ctliu3</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>