<!doctype html><html><head><title>Tips you should know about Caffe</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=https://ctliu3.github.io/scss/journal.min.f4a8de07567a2d29619e0711662ef6251e3e59b642079f99490f654abf89a3c4.css integrity="sha256-9KjeB1Z6LSlhngcRZi72JR4+WbZCB5+ZSQ9lSr+Jo8Q=" media=screen><link rel=stylesheet href=https://ctliu3.github.io/scss/dark-mode.min.eeb8040aa9333250b7fec770f950bfe8ba9b18a5eeeaf2dfef61d84d3956f625.css integrity="sha256-7rgECqkzMlC3/sdw+VC/6LqbGKXu6vLf72HYTTlW9iU=" media=screen><script src=/vendor/js/loadCSS.js></script>
<script>loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons")</script><script src=/js/toc.js></script>
<script src=https://cdn.jsdelivr.net/npm/vue-disqus@3/dist/vue-disqus.js></script></head><body><div id=app><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://ctliu3.github.io/><div class=nav-title>Space of ctliu3</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>归档</a>
<a class="a-block nav-link-item false" href=/categories>分类</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>移植自 <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
2017 Space of ctliu3</div></div><div id=extraContainer class=extra-container><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc-content><center>- 目录 -</center><ul><ul><ul><li><a href=#what-caffe-can-do onclick="onNavClick(`#what-caffe-can-do-nav`)" id=what-caffe-can-do-nav>What Caffe can do?</a></li><li><a href=#read-the-source-code onclick="onNavClick(`#read-the-source-code-nav`)" id=read-the-source-code-nav>Read the source code</a></li><li><a href=#features-extraction onclick="onNavClick(`#features-extraction-nav`)" id=features-extraction-nav>Features extraction</a></li><li><a href=#whats-more onclick="onNavClick(`#whats-more-nav`)" id=whats-more-nav>What’s more</a></li></ul></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a>
<a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>归档</a>
<a class="a-block drawer-menu-item false" href=/categories>分类</a></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu</i></button>
<a id=navTitle class=navbar-brand href=https://ctliu3.github.io/>Space of ctliu3</a>
<button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://ctliu3.github.io/><div class=single-column-header-title>Space of ctliu3</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>Tips you should know about Caffe<div class=post-meta><time itemprop=datePublished>2015-08-08 16:49</time>
<i class=material-icons>folder</i>
<a href=/categories/engineering>Engineering</a>
&nbsp;
<i class=material-icons>label</i>
<a href=/tags/caffe>Caffe</a>
&nbsp;
<a href=/tags/deep-learning>Deep Learning</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><p><a href=https://github.com/BVLC/caffe>Caffe</a> is a wonderful deep learning (DL) framework, written in C++ and it is still under construction. I use Caffe to do some image related tasks these days. Technologically, I use Caffe just around one week, so I’m also a newbie. I encounter some “pits” when using Caffe. So I write down some tips, hope they are helpful to you.</p><h3 id=what-caffe-can-do>What Caffe can do?</h3><p>Caffe is actually a feature learning tool, you can do some specific tasks like classification, clustering, segmentation with the help of it. You can define the structure of the network to train the model of your own. Otherwise, some pre-trained models, including <a href=https://github.com/BVLC/caffe/tree/master/models/bvlc_googlenet>googlenet</a>, <a href=https://github.com/BVLC/caffe/tree/master/models/bvlc_reference_caffenet>caffenet</a>, are provided, they can be used directly.</p><h3 id=read-the-source-code>Read the source code</h3><p>In some degree, Caffe is really a blackbox. Therefore, if you first time meet it, you may want to dig into the source code to see the scenery behind Caffe. Knowing the following modules, which are described in a high level, will make your travel easier.</p><ul><li><a href=https://github.com/BVLC/caffe/blob/master/src/caffe/blob.cpp>Blob</a>. The data that flows up and down in the deep learning network is wrapped by Blob class. Blob is a 4-dimensional (4D) data and it contains different kinds of information when it is in different positions in the net. For the input, the shape of data is <code>#image x #channel x height x width</code>. For the output, it is <code>#image x #class x 1 x 1</code>. Thus, you can compare the <code>#class</code> predictions and choose the maximal value to get which class each image belongs to.</li><li><a href=https://github.com/BVLC/caffe/blob/master/src/caffe/net.cpp>Net</a>. This module describes the DL net. You will find many variables in the <a href=https://github.com/BVLC/caffe/blob/master/src/caffe/net.cpp>net.cpp</a>, but don’t be dismay, many of them are used to keep the structure of DL net. Think about how you construct a <a href=https://en.wikipedia.org/wiki/Directed_acyclic_graph>circled acyclic graph</a> (DAG) in C++. It’s almost the same. But you do really need to know the input and output data of the net, as described above.</li><li><a href=https://github.com/BVLC/caffe/blob/master/src/caffe/layer_factory.cpp>Layer</a>. This is a significant module in Caffe. One thing you need to know is, for a layer, there may be more than one layers under it and more than one layer above it. That’s it. If you are not a researcher, you can skip this amount of implements of different layers, which make one petrified. But I do recommend you should understand the function of each layer by their layer types.</li></ul><p>Caffe uses <a href=https://developers.google.com/protocol-buffers/>protocol buffer</a> to define the data format, so reading the <a href=https://github.com/BVLC/caffe/blob/master/src/caffe/proto/caffe.proto>caffe.proto</a> file will be your first step before reading other parts of the source code.</p><h3 id=features-extraction>Features extraction</h3><p>Since DL net is a multiple layers network, you can extract the features generated in some layers to do the future task, such as clustering. Although you can extract any layer in the network, usually the last layer before output is a better option. The extracted features are stored in <code>leveldb</code> or <code>lmdb</code> format and you need to write code to obtain the plain data of feature data. There is a simple script written in python.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#069;font-weight:700>import</span> <span style=color:#0cf;font-weight:700>lmdb</span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>from</span> <span style=color:#0cf;font-weight:700>caffe.proto</span> <span style=color:#069;font-weight:700>import</span> caffe_pb2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>def</span> <span style=color:#c0f>save2txt</span>(db_name):
</span></span><span style=display:flex><span>    img_db <span style=color:#555>=</span> lmdb<span style=color:#555>.</span>open(db_name)
</span></span><span style=display:flex><span>    txn <span style=color:#555>=</span> img_db<span style=color:#555>.</span>begin()
</span></span><span style=display:flex><span>    cursor <span style=color:#555>=</span> txn<span style=color:#555>.</span>cursor()
</span></span><span style=display:flex><span>    cursor<span style=color:#555>.</span>iternext()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    datum <span style=color:#555>=</span> caffe_pb2<span style=color:#555>.</span>Datum()
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>for</span> key, value <span style=color:#000;font-weight:700>in</span> cursor:
</span></span><span style=display:flex><span>        datum<span style=color:#555>.</span>ParseFromString(value)
</span></span><span style=display:flex><span>        data <span style=color:#555>=</span> caffe<span style=color:#555>.</span>io<span style=color:#555>.</span>datum_to_array(datum)
</span></span><span style=display:flex><span>        data <span style=color:#555>=</span> np<span style=color:#555>.</span>reshape(data, (<span style=color:#f60>1</span>, np<span style=color:#555>.</span>product(data<span style=color:#555>.</span>shape)))[<span style=color:#f60>0</span>]
</span></span><span style=display:flex><span>       <span style=color:#555>//</span> data <span style=color:#000;font-weight:700>is</span> the feature <span style=color:#069;font-weight:700>with</span> shape (<span style=color:#09f;font-style:italic>#feat, ) </span>
</span></span><span style=display:flex><span>       <span style=color:#555>//</span> Your code<span style=color:#555>.</span>
</span></span></code></pre></div><h3 id=whats-more>What’s more</h3><p>During the usage of Caffe, you need to do lots of trivial work, like putting the data in certain directory, checking the output of each step is whether correct or not, or sometimes you need to visualize the output data in website in that you probably work on the remote machine, etc.
In light of this, being familiar with <a href=https://en.wikipedia.org/wiki/Bash_(Unix_shell)>bash/sh</a>, <a href=https://www.python.org>python</a> or <a href=https://www.ruby-lang.org/zh_cn/>ruby</a> will greatly improve your working efficiency. You can check my <a href=https://gist.github.com/ctliu3/fc1148da3922cff09eb7>code snippet</a> in github for fast learning of bash.</p><hr width=100% id=EOF><p style=color:#777>最后修改于 2015-08-08</p></div></div><nav class=post-pagination><a class=newer-posts href=https://ctliu3.github.io/posts/high-performance-image-prediction-service/>下回<br>Build a high performance image prediction service</a>
<a class=older-posts href=https://ctliu3.github.io/posts/nlp-pa-parsing/>上回<br>NLP PA: Parsing</a></nav><div class=post-comment-wrapper><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://ctliu3.github.io/posts/tips-you-should-know-about-caffe/",this.page.identifier="https://ctliu3.github.io/posts/tips-you-should-know-about-caffe/"};(function(){var e=document,t=e.createElement("script");t.src="https://ctliu3.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div></div></div></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>移植自 <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
2017 Space of ctliu3</div></div><script src=/js/journal.js></script></body></html>