<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Tips you should know about Caffe</title>
<meta name=description content="Moments of Life"><meta name=keywords content="Caffe,Deep Learning"><meta property="og:url" content="https://ctliu3.xyz/posts/tips-you-should-know-about-caffe/"><meta property="og:type" content="website"><meta property="og:title" content="Tips you should know about Caffe"><meta property="og:description" content="Moments of Life"><meta property="og:image" content="https://ctliu3.xyz/avatar.png"><meta property="og:image:secure_url" content="https://ctliu3.xyz/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Tips you should know about Caffe"><meta name=twitter:description content="Moments of Life"><meta property="twitter:domain" content="https://ctliu3.xyz/posts/tips-you-should-know-about-caffe/"><meta property="twitter:url" content="https://ctliu3.xyz/posts/tips-you-should-know-about-caffe/"><meta name=twitter:image content="https://ctliu3.xyz/avatar.png"><link rel=canonical href=https://ctliu3.xyz/posts/tips-you-should-know-about-caffe/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.edd985581bf860dfb4507e5885197f1680160c7fe19f23b31e183126d99dd596.js integrity="sha256-7dmFWBv4YN+0UH5YhRl/FoAWDH/hnyOzHhgxJtmd1ZY="></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css integrity=sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js integrity=sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://ctliu3.xyz/><img src=/avatar.png alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://ctliu3.xyz/>自由の灵魂</a></div><div class=nav-links><div class=nav-link><a href=https://ctliu3.xyz/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://ctliu3.xyz/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://ctliu3.xyz/about><span data-feather=user></span> About</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://ctliu3.xyz/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://ctliu3.xyz/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://ctliu3.xyz/about><span data-feather=user></span> About</a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Tips you should know about Caffe</h1><small role=doc-subtitle></small><p class=post-date>八月 8, 2015</p><ul class=post-tags><li class=post-tag><a href=https://ctliu3.xyz/tags/caffe>Caffe</a></li><li class=post-tag><a href=https://ctliu3.xyz/tags/deep-learning>Deep Learning</a></li></ul></div><div class=post-content><p><p><a href=https://github.com/BVLC/caffe>Caffe</a> is a wonderful deep learning (DL) framework, written in C++ and it is still under construction. I use Caffe to do some image related tasks these days. Technologically, I use Caffe just around one week, so I’m also a newbie. I encounter some “pits” when using Caffe. So I write down some tips, hope they are helpful to you.</p><h3 id=what-caffe-can-do>What Caffe can do?</h3><p>Caffe is actually a feature learning tool, you can do some specific tasks like classification, clustering, segmentation with the help of it. You can define the structure of the network to train the model of your own. Otherwise, some pre-trained models, including <a href=https://github.com/BVLC/caffe/tree/master/models/bvlc_googlenet>googlenet</a>, <a href=https://github.com/BVLC/caffe/tree/master/models/bvlc_reference_caffenet>caffenet</a>, are provided, they can be used directly.</p><h3 id=read-the-source-code>Read the source code</h3><p>In some degree, Caffe is really a blackbox. Therefore, if you first time meet it, you may want to dig into the source code to see the scenery behind Caffe. Knowing the following modules, which are described in a high level, will make your travel easier.</p><ul><li><a href=https://github.com/BVLC/caffe/blob/master/src/caffe/blob.cpp>Blob</a>. The data that flows up and down in the deep learning network is wrapped by Blob class. Blob is a 4-dimensional (4D) data and it contains different kinds of information when it is in different positions in the net. For the input, the shape of data is <code>#image x #channel x height x width</code>. For the output, it is <code>#image x #class x 1 x 1</code>. Thus, you can compare the <code>#class</code> predictions and choose the maximal value to get which class each image belongs to.</li><li><a href=https://github.com/BVLC/caffe/blob/master/src/caffe/net.cpp>Net</a>. This module describes the DL net. You will find many variables in the <a href=https://github.com/BVLC/caffe/blob/master/src/caffe/net.cpp>net.cpp</a>, but don’t be dismay, many of them are used to keep the structure of DL net. Think about how you construct a <a href=https://en.wikipedia.org/wiki/Directed_acyclic_graph>circled acyclic graph</a> (DAG) in C++. It’s almost the same. But you do really need to know the input and output data of the net, as described above.</li><li><a href=https://github.com/BVLC/caffe/blob/master/src/caffe/layer_factory.cpp>Layer</a>. This is a significant module in Caffe. One thing you need to know is, for a layer, there may be more than one layers under it and more than one layer above it. That’s it. If you are not a researcher, you can skip this amount of implements of different layers, which make one petrified. But I do recommend you should understand the function of each layer by their layer types.</li></ul><p>Caffe uses <a href=https://developers.google.com/protocol-buffers/>protocol buffer</a> to define the data format, so reading the <a href=https://github.com/BVLC/caffe/blob/master/src/caffe/proto/caffe.proto>caffe.proto</a> file will be your first step before reading other parts of the source code.</p><h3 id=features-extraction>Features extraction</h3><p>Since DL net is a multiple layers network, you can extract the features generated in some layers to do the future task, such as clustering. Although you can extract any layer in the network, usually the last layer before output is a better option. The extracted features are stored in <code>leveldb</code> or <code>lmdb</code> format and you need to write code to obtain the plain data of feature data. There is a simple script written in python.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> lmdb
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> caffe.proto <span style=color:#f92672>import</span> caffe_pb2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>save2txt</span>(db_name):
</span></span><span style=display:flex><span>    img_db <span style=color:#f92672>=</span> lmdb<span style=color:#f92672>.</span>open(db_name)
</span></span><span style=display:flex><span>    txn <span style=color:#f92672>=</span> img_db<span style=color:#f92672>.</span>begin()
</span></span><span style=display:flex><span>    cursor <span style=color:#f92672>=</span> txn<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>    cursor<span style=color:#f92672>.</span>iternext()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    datum <span style=color:#f92672>=</span> caffe_pb2<span style=color:#f92672>.</span>Datum()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> key, value <span style=color:#f92672>in</span> cursor:
</span></span><span style=display:flex><span>        datum<span style=color:#f92672>.</span>ParseFromString(value)
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> caffe<span style=color:#f92672>.</span>io<span style=color:#f92672>.</span>datum_to_array(datum)
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>reshape(data, (<span style=color:#ae81ff>1</span>, np<span style=color:#f92672>.</span>product(data<span style=color:#f92672>.</span>shape)))[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>       <span style=color:#f92672>//</span> data <span style=color:#f92672>is</span> the feature <span style=color:#66d9ef>with</span> shape (<span style=color:#75715e>#feat, ) </span>
</span></span><span style=display:flex><span>       <span style=color:#f92672>//</span> Your code<span style=color:#f92672>.</span>
</span></span></code></pre></div><h3 id=whats-more>What’s more</h3><p>During the usage of Caffe, you need to do lots of trivial work, like putting the data in certain directory, checking the output of each step is whether correct or not, or sometimes you need to visualize the output data in website in that you probably work on the remote machine, etc.
In light of this, being familiar with <a href=https://en.wikipedia.org/wiki/Bash_(Unix_shell)>bash/sh</a>, <a href=https://www.python.org>python</a> or <a href=https://www.ruby-lang.org/zh_cn/>ruby</a> will greatly improve your working efficiency. You can check my <a href=https://gist.github.com/ctliu3/fc1148da3922cff09eb7>code snippet</a> in github for fast learning of bash.</p></p></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="topFunction()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg><script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function topFunction(){smoothScrollToTop()}function smoothScrollToTop(){const e=()=>{const t=document.documentElement.scrollTop||document.body.scrollTop;t>0&&(window.requestAnimationFrame(e),window.scrollTo(0,t-t/8))};e()}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#what-caffe-can-do>What Caffe can do?</a></li><li><a href=#read-the-source-code>Read the source code</a></li><li><a href=#features-extraction>Features extraction</a></li><li><a href=#whats-more>What’s more</a></li></ul></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2023 ctliu3</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>